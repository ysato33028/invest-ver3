<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>まいばすけっと投資回収シミュレーション</title>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>まいばすけっと投資回収シミュレーション</h1>
    <form id="property-form">
        <div class="container">
            <div class="column">
            <h3><span>01</span>物件登録</h3>
            <table>
                <thead>
                    <tr>
                    <th>項目</th>
                    <th>詳細</th>
                　　</tr>
                </thead>
                <tbody>
                    <tr>
                    <td><label for="name">物件名:</label></td>
                    <td><input type="text" id="name" required></td>
                </tr>
                <tr>
                    <td><label for="annualSales">想定売上 (円):</label></td>
                    <td><input type="number" id="annualSales" required></td>
                </tr>
                <tr>
                    <td><label for="total-investment-input">設備投資合計 (円):</label></td>
                    <td><input type="number" id="total-investment-input" required></td>
                </tr>
                <tr>
                    <td><label for="depreciation">償却月数 (月):</label></td>
                    <td><input type="number" id="depreciation" required></td>
                </tr>
                </tbody>
            </table>  
            </div>
            <div class="column">
            <h3><span>02</span>費用情報</h3>
            <table>
                <thead>
                    <tr>
                    <th>項目</th>
                    <th>詳細</th>
                　　</tr>
                </thead>
                <tbody>
                    <tr>
                    <td><label for="personnel">人件費 (円):</label></td>
                    <td><input type="number" id="personnel" required></td>
                </tr>
                <tr>
                    <td><label for="promotion">販売促進費 (円):</label></td>
                    <td><input type="number" id="promotion" required></td>
                </tr>
                <tr>
                    <td><label for="equipmentCost">設備費 (円):</label></td>
                    <td><input type="number" id="equipmentCost" required></td>
                </tr>
                <tr>
                    <td><label for="general">一般費用 (円):</label></td>
                    <td><input type="number" id="general" required></td>
                </tr>
                </tbody>
            </table>
            </div>
            <div class="column">
            <h3><span>03</span>設備費情報</h3>
            <table>
                <thead>
                    <tr>
                    <th>項目</th>
                    <th>詳細</th>
                　　</tr>
                </thead>
                <tbody>
                    <tr>
                    <td><label for="utilityCost">水道光熱費 (円):</label></td>
                    <td><input type="number" id="utilityCost" required></td>
                </tr>
                <tr>
                    <td><label for="landRent">地代家賃 (円):</label></td>
                    <td><input type="number" id="landRent" required></td>
                </tr>
                <tr>
                    <td><label for="commonAreaFee">共益費 (円):</label></td>
                    <td><input type="number" id="commonAreaFee" required></td>
                </tr>
                <tr>
                    <td><label for="expenseAllocation">経費按分 (%):</label></td>
                    <td><input type="number" id="expenseAllocation" step="0.1" required></td>
                </tr>
                </tbody>
            </table> 
            </div>
        </div>
        <input id="save" type="submit" value="保存" /></input>
    </form>
        <h3><span>04</span>売上計画 (%)</h3>
        <table>
            <thead>
                <tr>
                <th>項目</th>
                <th>1年目</th>
                <th>2年目</th>
                <th>3年目</th>
                <th>4年目</th>
                <th>5年目</th>
            　　</tr>
            </thead>
            <tbody>
                <tr>
                <td>売上伸び率 (%)</td>
                <td><input type="number" id="growthRateYear1" value="100" readonly></td>
                <td><input type="number" id="growthRateYear2" step="0.1" required></td>
                <td><input type="number" id="growthRateYear3" step="0.1" required></td>
                <td><input type="number" id="growthRateYear4" step="0.1" required></td>
                <td><input type="number" id="growthRateYear5" step="0.1" required></td>
            </tr>
            <tr>
                <td>荒利率 (%)</td>
                <td><input type="number" id="marginRateYear1" step="0.1" required></td>
                <td><input type="number" id="marginRateYear2" step="0.1" required></td>
                <td><input type="number" id="marginRateYear3" step="0.1" required></td>
                <td><input type="number" id="marginRateYear4" step="0.1" required></td>
                <td><input type="number" id="marginRateYear5" step="0.1" required></td>
            </tr>
            </tbody>
        </table>
        <input id="simulate" type="button" value="シミュレーション結果" /></input>

    <h3><span>05</span>シミュレーション結果</h3>
    <table id="simulation-results">
        <thead>
            <tr>
                <th>項目</th>
                <th>1年目</th>
                <th>2年目</th>
                <th>3年目</th>
                <th>4年目</th>
                <th>5年目</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>売上高 (円)</td>
                <td id="salesYear1"></td>
                <td id="salesYear2"></td>
                <td id="salesYear3"></td>
                <td id="salesYear4"></td>
                <td id="salesYear5"></td>
            </tr>
            <tr>
                <td>売上原価 (円)</td>
                <td id="costOfSalesYear1"></td>
                <td id="costOfSalesYear2"></td>
                <td id="costOfSalesYear3"></td>
                <td id="costOfSalesYear4"></td>
                <td id="costOfSalesYear5"></td>
            </tr>
            <tr>
                <td>売上純利益 (円)</td>
                <td id="gross-profitYear1"></td>
                <td id="gross-profitYear2"></td>
                <td id="gross-profitYear3"></td>
                <td id="gross-profitYear4"></td>
                <td id="gross-profitYear5"></td>
            </tr>
            <tr>
                <td>人件費 (円)</td>
                <td id="total-personnelYear1"></td>
                <td id="total-personnelYear2"></td>
                <td id="total-personnelYear3"></td>
                <td id="total-personnelYear4"></td>
                <td id="total-personnelYear5"></td>
            </tr>
            <tr>
                <td>販売促進費 (円)</td>
                <td id="total-promotionYear1"></td>
                <td id="total-promotionYear2"></td>
                <td id="total-promotionYear3"></td>
                <td id="total-promotionYear4"></td>
                <td id="total-promotionYear5"></td>
            </tr>
            <tr>
                <td>販売費一般管理費合計 (円)</td>
                <td id="total-sgaYear1"></td>
                <td id="total-sgaYear2"></td>
                <td id="total-sgaYear3"></td>
                <td id="total-sgaYear4"></td>
                <td id="total-sgaYear5"></td>
            </tr>
            <tr>
                <td>営業利益 (円)</td>
                <td id="operating-profitYear1"></td>
                <td id="operating-profitYear2"></td>
                <td id="operating-profitYear3"></td>
                <td id="operating-profitYear4"></td>
                <td id="operating-profitYear5"></td>
            </tr>
            <tr>
                <td>税金概算（40％） (円)</td>
                <td id="taxYear1"></td>
                <td id="taxYear2"></td>
                <td id="taxYear3"></td>
                <td id="taxYear4"></td>
                <td id="taxYear5"></td>
            </tr>
            <tr>
                <td>税引後純利益 (円)</td>
                <td id="net-incomeYear1"></td>
                <td id="net-incomeYear2"></td>
                <td id="net-incomeYear3"></td>
                <td id="net-incomeYear4"></td>
                <td id="net-incomeYear5"></td>
            </tr>
            <tr>
                <td>キャッシュフロー (円)</td>
                <td id="cash-flowYear1"></td>
                <td id="cash-flowYear2"></td>
                <td id="cash-flowYear3"></td>
                <td id="cash-flowYear4"></td>
                <td id="cash-flowYear5"></td>
            </tr>
            <tr>
                <td>投資回収残高 (円)</td>
                <td id="investment-recoveryYear1"></td>
                <td id="investment-recoveryYear2"></td>
                <td id="investment-recoveryYear3"></td>
                <td id="investment-recoveryYear4"></td>
                <td id="investment-recoveryYear5"></td>
            </tr>
        </tbody>
    </table>
    </form>
    <button id="export-ppt-button" class="btn-edit" type="button" value="PPTエクスポート" /></button>
    <div class="container">
        <div class="column">
            <h2>物件検索</h2>
            <form id="search-form">
                <input type="text" id="search" placeholder="物件名を入力" />
                <input id="search-button" type="submit" value="検索" /></input>
            </form>
        </div>
        <div class="column">
            <h2>物件登録一覧</h2>
            <input id="list-all" type="button" value="登録一覧を表示" /></input>
        </div>
    </div>
    <h2>検索結果</h2>
    <ul id="property-list"></ul>
    <script src="script.js"></script>
    <script type="module">
        // シミュレーション結果の計算処理
        document.getElementById("simulate").addEventListener("click", () => {
        const annualSales = Number(document.getElementById("annualSales").value);
        const growthRates = [
          100, // 1年目の売上伸び率は100%（固定）
          Number(document.getElementById("growthRateYear2").value),
          Number(document.getElementById("growthRateYear3").value),
          Number(document.getElementById("growthRateYear4").value), 
          Number(document.getElementById("growthRateYear5").value)
        ];
        const marginRates = [
          Number(document.getElementById("marginRateYear1").value),
          Number(document.getElementById("marginRateYear2").value),
          Number(document.getElementById("marginRateYear3").value),
          Number(document.getElementById("marginRateYear4").value),
          Number(document.getElementById("marginRateYear5").value)
        ];

        // 投資・物件条件の入力値を取得
        const totalInitial = parseFloat(document.getElementById('total-investment-input').value) || 0;
        const depreciation = parseFloat(document.getElementById('depreciation').value) || 0;
        const personnel = parseFloat(document.getElementById('personnel').value) || 0;
        const promotion = parseFloat(document.getElementById('promotion').value) || 0;
        const equipmentCost = parseFloat(document.getElementById('equipmentCost').value) || 0;
        const general = parseFloat(document.getElementById('general').value) || 0;
        const utilityCost = parseFloat(document.getElementById('utilityCost').value) || 0;
        const landRent = parseFloat(document.getElementById('landRent').value) || 0;
        const commonAreaFee = parseFloat(document.getElementById('commonAreaFee').value) || 0;
        const expenseAllocation = parseFloat(document.getElementById('expenseAllocation').value) || 0;

        const promotionData = [
            data.promotion || 0, 
            data.promotion2 || 0, 
            data.promotion3 || 0,
            data.promotion4 || 0, 
            data.promotion5 || 0
        ];

        const equipmentCostData = [
            data.equipmentCost || 0, 
            data.equipmentCost2 || 0, 
            data.equipmentCost3 || 0,
            data.equipmentCost4 || 0, 
            data.equipmentCost5 || 0
        ];

        const generalData = [
            data.general || 0, 
            data.general2 || 0, 
            data.general3 || 0,
            data.general4 || 0, 
            data.general5 || 0
        ];

        let cumulativeCashFlow = 0;
        let investmentBalance = -totalInitial;

        // 売上高の計算処理
        let previousSales = annualSales; // 初年度の売上高
        for (let year = 1; year <= 5; year++) {
          const sales = previousSales;
          const costOfSales = sales * (1 - (marginRates[year - 1] / 100)); // 売上原価
          const profit = sales - costOfSales; // 売上総利益

          // 年間の月間運営費用を算出
          const annualPersonnel = personnel;

          // 年間の販促費用を年ごとに切り替え
          const annualPromotion = promotionData[year - 1]; // 年ごとの販促費用

          // 年間の設備費用を年ごとに切り替え
          const annualEquipmentCost = equipmentCostData[year - 1]; // 年ごとの販促費用

          // 年間の一般費用を年ごとに切り替え
          const annualGeneral = generalData[year - 1]; // 年ごとの販促費用

          const annualOperatingCosts = annualPersonnel + annualPromotion + annualEquipmentCost + annualGeneral;

          const totalPersonnel = annualPersonnel;  // 人件費計
          const totalPromotion = annualPromotion;  // 販売促進費計
          const totalEquipmentCost = annualEquipmentCost;  // 設備費計
          const annualDepreciation = totalInitial / depreciation * 12;  // 減価償却費
          const totalSGA = annualOperatingCosts;  // 販売費一般管理費合計
          const operatingProfit = profit - totalSGA;  // 営業利益
          const tax = operatingProfit * 0.4;  // 税金概算（40％）
          const netIncome = operatingProfit - tax;  // 税引後純利益
          const cashFlow = netIncome + annualDepreciation;  // 営業キャッシュフロー

          // 投資回収残高の計算
          cumulativeCashFlow += cashFlow;
          const investmentRecoveryBalance = investmentBalance + cumulativeCashFlow;

          // 結果の表示
          document.getElementById(`salesYear${year}`).textContent = Math.trunc(sales).toLocaleString();
          document.getElementById(`costOfSalesYear${year}`).textContent = Math.trunc(costOfSales).toLocaleString();
          document.getElementById(`gross-profitYear${year}`).textContent = Math.trunc(profit).toLocaleString();
          document.getElementById(`total-personnelYear${year}`).textContent = Math.trunc(totalPersonnel).toLocaleString();
          document.getElementById(`total-promotionYear${year}`).textContent = Math.trunc(totalPromotion).toLocaleString();
          document.getElementById(`total-sgaYear${year}`).textContent = Math.trunc(totalSGA).toLocaleString();
          document.getElementById(`operating-profitYear${year}`).textContent = Math.trunc(operatingProfit).toLocaleString();
          document.getElementById(`taxYear${year}`).textContent = Math.trunc(tax).toLocaleString();
          document.getElementById(`net-incomeYear${year}`).textContent = Math.trunc(netIncome).toLocaleString();
          document.getElementById(`cash-flowYear${year}`).textContent = Math.trunc(cashFlow).toLocaleString();

          // 投資回収残高を表示
          const recoveryBalanceText = investmentRecoveryBalance >= 0 ?
              `${Math.trunc(investmentRecoveryBalance).toLocaleString()} ` :
              `<span style="color: red;">▲ ${Math.abs(Math.trunc(investmentRecoveryBalance)).toLocaleString()} </span>`;

          document.getElementById(`investment-recoveryYear${year}`).innerHTML = recoveryBalanceText;

          // 成長率に基づく次年度の売上高を計算
          previousSales = sales * (growthRates[year] / 100); // 次年度の売上高
        }
      });

      // Firebase App (必須)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

      // Firebaseの初期化
      const firebaseConfig = {
        apiKey: "AIzaSyB5Q-33mnR0OHCIgRfsZQqhp3DtJl_HqSo",
        authDomain: "localstorage-350f8.firebaseapp.com",
        projectId: "localstorage-350f8",
        storageBucket: "localstorage-350f8.appspot.com",
        messagingSenderId: "813792564394",
        appId: "1:813792564394:web:f0647834bbfc23e6c36cd3"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // フォームの送信処理（保存）
      document.getElementById("property-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("name").value;
        const annualSales = Number(document.getElementById("annualSales").value);
        const totalInitial = Number(document.getElementById("total-investment-input").value);
        const depreciation = Number(document.getElementById("depreciation").value);
        const personnel = Number(document.getElementById("personnel").value);
        const promotion = Number(document.getElementById("promotion").value);
        const equipmentCost = Number(document.getElementById("equipmentCost").value);
        const general = Number(document.getElementById("general").value);
        const growthRateYear2 = Number(document.getElementById("growthRateYear2").value);
        const growthRateYear3 = Number(document.getElementById("growthRateYear3").value);
        const growthRateYear4 = Number(document.getElementById("growthRateYear4").value);
        const growthRateYear5 = Number(document.getElementById("growthRateYear5").value);
        const marginRateYear1 = Number(document.getElementById("marginRateYear1").value);
        const marginRateYear2 = Number(document.getElementById("marginRateYear2").value);
        const marginRateYear3 = Number(document.getElementById("marginRateYear3").value);
        const marginRateYear4 = Number(document.getElementById("marginRateYear4").value);
        const marginRateYear5 = Number(document.getElementById("marginRateYear5").value);
        const utilityCost = Number(document.getElementById("utilityCost").value);
        const landRent = Number(document.getElementById("landRent").value);
        const commonAreaFee = Number(document.getElementById("commonAreaFee").value);
        const expenseAllocation = Number(document.getElementById("expenseAllocation").value);

        // 成長率を配列で取得
        const growthRates = [
            Number(document.getElementById("growthRateYear2").value),
            Number(document.getElementById("growthRateYear3").value),
            Number(document.getElementById("growthRateYear4").value),
            Number(document.getElementById("growthRateYear5").value)
          ];

        // Firebaseに保存するためのデータオブジェクト
        const salesData = {
            salesYear1: Number(document.getElementById("salesYear1").value) || 0,
            salesYear2: Number(document.getElementById("salesYear2").value) || 0,
            salesYear3: Number(document.getElementById("salesYear3").value) || 0,
            salesYear4: Number(document.getElementById("salesYear4").value) || 0,
            salesYear5: Number(document.getElementById("salesYear5").value) || 0
        };

        // Firebaseに保存するためのデータオブジェクト
        const cashFlowData = {
            cashFlowYear1: Number(document.getElementById("cash-flowYear1").textContent.replace(/,/g, '')) || 0,
            cashFlowYear2: Number(document.getElementById("cash-flowYear2").textContent.replace(/,/g, '')) || 0,
            cashFlowYear3: Number(document.getElementById("cash-flowYear3").textContent.replace(/,/g, '')) || 0,
            cashFlowYear4: Number(document.getElementById("cash-flowYear4").textContent.replace(/,/g, '')) || 0,
            cashFlowYear5: Number(document.getElementById("cash-flowYear5").textContent.replace(/,/g, '')) || 0
        };

        // Firebaseに保存するためのデータオブジェクト
        const investmentRecoveryBalanceData = {
            investmentRecoveryBalanceYear1: Number(document.getElementById("investment-recoveryYear1").innerHTML.replace(/,/g, '')) || 0,
            investmentRecoveryBalanceYear2: Number(document.getElementById("investment-recoveryYear2").innerHTML.replace(/,/g, '')) || 0,
            investmentRecoveryBalanceYear3: Number(document.getElementById("investment-recoveryYear3").innerHTML.replace(/,/g, '')) || 0,
            investmentRecoveryBalanceYear4: Number(document.getElementById("investment-recoveryYear4").innerHTML.replace(/,/g, '')) || 0,
            investmentRecoveryBalanceYear5: Number(document.getElementById("investment-recoveryYear5").innerHTML.replace(/,/g, '')) || 0
        };

        for (let year = 1; year <= 5; year++) {
            if (year === 1) {
              salesData[`salesYear${year}`] = annualSales; // 1年目はそのまま
            } else {
              salesData[`salesYear${year}`] = salesData[`salesYear${year - 1}`] * (growthRates[year - 2] / 100); // 2年目以降の成長率適用
            }
        }

        try {
          // 既存の物件名があるかチェック
          const propertiesRef = collection(db, "properties");
          const q = query(propertiesRef, where("name", "==", name));
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            // 物件名がすでに存在する場合、上書きするか確認
            if (confirm("同じ物件名で登録されています。上書きしてもいいですか？")) {
              // 上書き処理
              const docId = querySnapshot.docs[0].id;
              const docRef = doc(db, "properties", docId);
              await updateDoc(docRef, {
                annualSales: annualSales,
                totalInitial: totalInitial,
                depreciation: depreciation,
                personnel: personnel,
                promotion: promotion,
                equipmentCost: equipmentCost,
                general: general,
                growthRateYear2: growthRateYear2,
                growthRateYear3: growthRateYear3,
                growthRateYear4: growthRateYear4,
                growthRateYear5: growthRateYear5,
                marginRateYear1: marginRateYear1,
                marginRateYear2: marginRateYear2,
                marginRateYear3: marginRateYear3,
                marginRateYear4: marginRateYear4,
                marginRateYear5: marginRateYear5,
                utilityCost: utilityCost,
                landRent: landRent,
                commonAreaFee: commonAreaFee,
                expenseAllocation: expenseAllocation,
                ...salesData, // 追加したシミュレーション結果を保存
                ...cashFlowData, // 追加したシミュレーション結果を保存
                ...investmentRecoveryBalanceData // 追加したシミュレーション結果を保存
              });

              alert("データが上書きされました");
            }
          } else {
            // 新規登録
            await addDoc(propertiesRef, {
              name: name,
              annualSales: annualSales,
              totalInitial: totalInitial,
              depreciation: depreciation,
              personnel: personnel,
              promotion: promotion,
              equipmentCost: equipmentCost,
              general: general,
              growthRateYear2: growthRateYear2,
              growthRateYear3: growthRateYear3,
              growthRateYear4: growthRateYear4,
              growthRateYear5: growthRateYear5,
              marginRateYear1: marginRateYear1,
              marginRateYear2: marginRateYear2,
              marginRateYear3: marginRateYear3,
              marginRateYear4: marginRateYear4,
              marginRateYear5: marginRateYear5,
              utilityCost: utilityCost,
              landRent: landRent,
              commonAreaFee: commonAreaFee,
              expenseAllocation: expenseAllocation,
              ...salesData, // 追加したシミュレーション結果を保存
              ...cashFlowData, // 追加したシミュレーション結果を保存
              ...investmentRecoveryBalanceData // 追加したシミュレーション結果を保存
            });

            alert("データが保存されました");
          }
        } catch (error) {
          console.error("エラーが発生しました: ", error);
        }
      });

      // フォームの送信処理（検索）
      document.getElementById("search-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const searchQuery = document.getElementById("search").value.trim().toLowerCase();

        try {
          const propertyList = document.getElementById("property-list");
          propertyList.innerHTML = ""; // リストをクリア

          const propertiesRef = collection(db, "properties");
          const querySnapshot = await getDocs(propertiesRef);

          let resultsFound = false;

          querySnapshot.forEach((doc) => {
            const data = doc.data();

            // 安全にチェックしてから `toLowerCase()` を適用
            if (data.name && typeof data.name === 'string' && data.name.toLowerCase().includes(searchQuery)) {
              resultsFound = true;
              const listItem = document.createElement("li");
              listItem.innerHTML = `
                  <table>
                    <thead>
                        <tr>
                        <th>物件名</th>
                        <th>想定売上</th>
                        <th>データセット</th>
                        <th>物件削除</th>
                    　　</tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${data.name}</td>
                            <td>${data.annualSales}</td>
                            <td><button class="btn-edit" onclick="usePropertyData('${doc.id}')">使用</button></td>
                            <td><button class="btn-delete" onclick="deleteProperty('${doc.id}')">削除</button></td>
                        </tr>
                    </tbody>
                </table>
                <table>
                    <thead>
                        <tr>
                        <th>項目</th>
                        <th>1年目</th>
                        <th>2年目</th>
                        <th>3年目</th>
                        <th>4年目</th>
                        <th>5年目</th>
                    　　</tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>売上編集</td>
                            <td><button class="btn-edit" onclick="goToSales('${doc.id}')">初年度</button></td>
                            <td><button class="btn-edit" onclick="goToSales2('${doc.id}')">2年目</button></td>
                            <td><button class="btn-edit" onclick="goToSales3('${doc.id}')">3年目</button></td>
                            <td><button class="btn-edit" onclick="goToSales4('${doc.id}')">4年目</button></td>
                            <td><button class="btn-edit" onclick="goToSales5('${doc.id}')">5年目</button></td>
                        </tr>
                        <tr>
                            <td>初期投資編集</td>
                            <td><button class="btn-edit" onclick="goToInitial('${doc.id}')">一律編集</button></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>人件費編集</td>
                            <td><button class="btn-edit" onclick="goToPersonnel('${doc.id}')">一律編集</button></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>販促費編集</td>
                            <td><button class="btn-edit" onclick="goToPromotion('${doc.id}')">初年度</button></td>
                            <td><button class="btn-edit" onclick="goToPromotion2('${doc.id}')">2年目</button></td>
                            <td><button class="btn-edit" onclick="goToPromotion3('${doc.id}')">3年目</button></td>
                            <td><button class="btn-edit" onclick="goToPromotion4('${doc.id}')">4年目</button></td>
                            <td><button class="btn-edit" onclick="goToPromotion5('${doc.id}')">5年目</button></td>
                        </tr>
                        <tr>
                            <td>設備費編集</td>
                            <td><button class="btn-edit" onclick="goToEquipment('${doc.id}')">初年度</button></td>
                            <td><button class="btn-edit" onclick="goToEquipment2('${doc.id}')">2年目</button></td>
                            <td><button class="btn-edit" onclick="goToEquipment3('${doc.id}')">3年目</button></td>
                            <td><button class="btn-edit" onclick="goToEquipment4('${doc.id}')">4年目</button></td>
                            <td><button class="btn-edit" onclick="goToEquipment5('${doc.id}')">5年目</button></td>
                        </tr>
                        <tr>
                            <td>一般費編集</td>
                            <td><button class="btn-edit" onclick="goToGeneral('${doc.id}')">初年度</button></td>
                            <td><button class="btn-edit" onclick="goToGeneral2('${doc.id}')">2年目</button></td>
                            <td><button class="btn-edit" onclick="goToGeneral3('${doc.id}')">3年目</button></td>
                            <td><button class="btn-edit" onclick="goToGeneral4('${doc.id}')">4年目</button></td>
                            <td><button class="btn-edit" onclick="goToGeneral5('${doc.id}')">5年目</button></td>
                        </tr>
                        <tr>
                            <td>月度別計画</td>
                            <td><button class="btn-edit" onclick="goToMonthly('${doc.id}')">初年度</button></td>
                            <td><button class="btn-edit" onclick="goToMonthly2('${doc.id}')">2年目</button></td>
                            <td><button class="btn-edit" onclick="goToMonthly3('${doc.id}')">3年目</button></td>
                            <td><button class="btn-edit" onclick="goToMonthly4('${doc.id}')">4年目</button></td>
                            <td><button class="btn-edit" onclick="goToMonthly5('${doc.id}')">5年目</button></td>
                        </tr>
                    </tbody>
                </table>
              `;
              propertyList.appendChild(listItem);
            }
          });

            if (!resultsFound) {
                alert("その物件名では登録がありません");
            }
          } catch (error) {
            console.error("検索に失敗しました: ", error);
          }
        });

        // 初期投資ページに遷移する関数
        window.goToInitial = function(id) {
          window.open(`initial-edit.html?id=${id}`, '_blank');
        }

        // 人件費ページに遷移する関数
        window.goToPersonnel = function(id) {
          window.open(`personnel-edit.html?id=${id}`, '_blank');
        }

        // 販促費ページに遷移する関数
        window.goToPromotion = function(id) {
          window.open(`promotion-edit.html?id=${id}`, '_blank');
        }

        // 販促費ページに遷移する関数
        window.goToPromotion2 = function(id) {
          window.open(`promotion-edit2.html?id=${id}`, '_blank');
        }

        // 販促費ページに遷移する関数
        window.goToPromotion3 = function(id) {
          window.open(`promotion-edit3.html?id=${id}`, '_blank');
        }

        // 販促費ページに遷移する関数
        window.goToPromotion4 = function(id) {
          window.open(`promotion-edit4.html?id=${id}`, '_blank');
        }

        // 販促費ページに遷移する関数
        window.goToPromotion5 = function(id) {
          window.open(`promotion-edit5.html?id=${id}`, '_blank');
        }

        // 設備費ページに遷移する関数
        window.goToEquipment = function(id) {
          window.open(`equipment-edit.html?id=${id}`, '_blank');
        }

        // 設備費ページに遷移する関数
        window.goToEquipment2 = function(id) {
          window.open(`equipment-edit2.html?id=${id}`, '_blank');
        }

        // 設備費ページに遷移する関数
        window.goToEquipment3 = function(id) {
          window.open(`equipment-edit3.html?id=${id}`, '_blank');
        }

        // 設備費ページに遷移する関数
        window.goToEquipment4 = function(id) {
          window.open(`equipment-edit4.html?id=${id}`, '_blank');
        }

        // 設備費ページに遷移する関数
        window.goToEquipment5 = function(id) {
          window.open(`equipment-edit5.html?id=${id}`, '_blank');
        }

        // 一般費ページに遷移する関数
        window.goToGeneral = function(id) {
          window.open(`general-edit.html?id=${id}`, '_blank');
        }

        // 一般費ページに遷移する関数
        window.goToGeneral2 = function(id) {
          window.open(`general-edit2.html?id=${id}`, '_blank');
        }

        // 一般費ページに遷移する関数
        window.goToGeneral3 = function(id) {
          window.open(`general-edit3.html?id=${id}`, '_blank');
        }

        // 一般費ページに遷移する関数
        window.goToGeneral4 = function(id) {
          window.open(`general-edit4.html?id=${id}`, '_blank');
        }

        // 一般費ページに遷移する関数
        window.goToGeneral5 = function(id) {
          window.open(`general-edit5.html?id=${id}`, '_blank');
        }

        // 月度ページに遷移する関数
        window.goToMonthly = function(id) {
          window.open(`monthly.html?id=${id}`, '_blank');
        }

        // 月度ページに遷移する関数
        window.goToMonthly2 = function(id) {
          window.open(`monthly2.html?id=${id}`, '_blank');
        }

        // 月度ページに遷移する関数
        window.goToMonthly3 = function(id) {
          window.open(`monthly3.html?id=${id}`, '_blank');
        }

        // 月度ページに遷移する関数
        window.goToMonthly4 = function(id) {
          window.open(`monthly4.html?id=${id}`, '_blank');
        }

        // 月度ページに遷移する関数
        window.goToMonthly5 = function(id) {
          window.open(`monthly5.html?id=${id}`, '_blank');
        }

        // 売上ページに遷移する関数
        window.goToSales = function(id) {
          window.open(`sales-edit.html?id=${id}`, '_blank');
        }

        // 売上ページに遷移する関数
        window.goToSales2 = function(id) {
          window.open(`sales-edit2.html?id=${id}`, '_blank');
        }

        // 売上ページに遷移する関数
        window.goToSales3 = function(id) {
          window.open(`sales-edit3.html?id=${id}`, '_blank');
        }

        // 売上ページに遷移する関数
        window.goToSales4 = function(id) {
          window.open(`sales-edit4.html?id=${id}`, '_blank');
        }

        // 売上ページに遷移する関数
        window.goToSales5 = function(id) {
          window.open(`sales-edit5.html?id=${id}`, '_blank');
        }

        // 全物件を表示するボタンの処理
        document.getElementById("list-all").addEventListener("click", async () => {
          try {
            const propertyList = document.getElementById("property-list");
            propertyList.innerHTML = ""; // リストをクリア

            const propertiesRef = collection(db, "properties");
            const querySnapshot = await getDocs(propertiesRef);

            if (querySnapshot.empty) {
              alert("登録された物件はありません");
            } else {
              querySnapshot.forEach((doc) => {
                const data = doc.data();
                const listItem = document.createElement("li");
                listItem.innerHTML = `
                  <table>
                    <thead>
                        <tr>
                        <th>物件名</th>
                        <th>想定売上</th>
                        <th>データセット</th>
                        <th>物件削除</th>
                    　　</tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${data.name}</td>
                            <td>${data.annualSales}</td>
                            <td><button class="btn-edit" onclick="usePropertyData('${doc.id}')">使用</button></td>
                            <td><button class="btn-delete" onclick="deleteProperty('${doc.id}')">削除</button></td>
                        </tr>
                    </tbody>
                </table>
                `;
                propertyList.appendChild(listItem);
              });
            }
          } catch (error) {
            console.error("一覧の取得に失敗しました: ", error);
          }
        });

          // 物件を削除する関数
        window.deleteProperty = async function(docId) {
          if (confirm("本当に削除しますか？")) {
            try {
              // Firestoreから物件を削除
              await deleteDoc(doc(db, "properties", docId));
              alert("物件が削除されました");
              // ページを再読み込みしてリストを更新
              location.reload();
            } catch (error) {
              console.error("削除に失敗しました: ", error);
              alert("物件の削除に失敗しました");
            }
          }
        }

        let data = {}; // グローバル変数としてデータを保存

        // 物件のデータを使用する関数
        window.usePropertyData = async function(docId) {
          try {
            // Firestoreから物件データを取得
            const docRef = doc(db, "properties", docId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
              // 取得したデータをフォームに入力
              data = docSnap.data(); // グローバル変数にデータを保存
              document.getElementById("name").value = data.name || '';
              document.getElementById("annualSales").value = data.annualSales || '';
              document.getElementById("total-investment-input").value = data.totalInitial || '';
              document.getElementById("depreciation").value = data.depreciation || '';
              document.getElementById("personnel").value = data.personnel || '';
              document.getElementById("promotion").value = data.promotion || '';
              document.getElementById("equipmentCost").value = data.equipmentCost || '';
              document.getElementById("general").value = data.general || '';
              document.getElementById("growthRateYear2").value = data.growthRateYear2 || '';
              document.getElementById("growthRateYear3").value = data.growthRateYear3 || '';
              document.getElementById("growthRateYear4").value = data.growthRateYear4 || '';
              document.getElementById("growthRateYear5").value = data.growthRateYear5 || '';
              document.getElementById("marginRateYear1").value = data.marginRateYear1 || '';
              document.getElementById("marginRateYear2").value = data.marginRateYear2 || '';
              document.getElementById("marginRateYear3").value = data.marginRateYear3 || '';
              document.getElementById("marginRateYear4").value = data.marginRateYear4 || '';
              document.getElementById("marginRateYear5").value = data.marginRateYear5 || '';
              document.getElementById("utilityCost").value = data.utilityCost || '';
              document.getElementById("landRent").value = data.landRent || '';
              document.getElementById("commonAreaFee").value = data.commonAreaFee || '';
              document.getElementById("expenseAllocation").value = data.expenseAllocation || '';

              // 取得した販促費データの取得 (存在する場合のみ)
              const promotion2Element = document.getElementById("promotion2");
              const promotion3Element = document.getElementById("promotion3");
              const promotion4Element = document.getElementById("promotion4");
              const promotion5Element = document.getElementById("promotion5");

              if (promotion2Element) {
                promotion2Element.value = data.promotion2 || 0;
              }
              if (promotion3Element) {
                promotion3Element.value = data.promotion3 || 0;
              }
              if (promotion4Element) {
                promotion4Element.value = data.promotion4 || 0;
              }
              if (promotion5Element) {
                promotion5Element.value = data.promotion5 || 0;
              }

              // 取得した設備費データの取得 (存在する場合のみ)
              const equipmentCost2Element = document.getElementById("equipmentCost2");
              const equipmentCost3Element = document.getElementById("equipmentCost3");
              const equipmentCost4Element = document.getElementById("equipmentCost4");
              const equipmentCost5Element = document.getElementById("equipmentCost5");

              if (equipmentCost2Element) {
                equipmentCost2Element.value = data.equipmentCost2 || 0;
              }
              if (equipmentCost3Element) {
                equipmentCost3Element.value = data.equipmentCost3 || 0;
              }
              if (equipmentCost4Element) {
                equipmentCost4Element.value = data.equipmentCost4 || 0;
              }
              if (equipmentCost5Element) {
                equipmentCost5Element.value = data.equipmentCost5 || 0;
              }


            　// 取得した一般費データの取得 (存在する場合のみ)
              const general2Element = document.getElementById("general2");
              const general3Element = document.getElementById("general3");
              const general4Element = document.getElementById("general4");
              const general5Element = document.getElementById("general5");

              if (general2Element) {
                general2Element.value = data.general2 || 0;
              }
              if (general3Element) {
                general3Element.value = data.general3 || 0;
              }
              if (general4Element) {
                general4Element.value = data.general4 || 0;
              }
              if (general5Element) {
                general5Element.value = data.general5 || 0;
              }


              alert("データがフォームに入力されました");
            } else {
              alert("データが見つかりませんでした");
            }
          } catch (error) {
            console.error("データの取得に失敗しました: ", error);
         }
        }
</script>
</body>
</html>
