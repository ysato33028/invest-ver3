<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一般費編集ページ</title>
    <link rel="stylesheet" href="edit-styles.css">
</head>
<body>
    <h2>一般費編集ページ（4年目）</h2>
    <form id="general-edit-form">
        <table>
            <thead>
                <tr>
                    <th>項目</th>
                    <th>指数設定及び各部署負担 (%)</th>
                    <th>1月</th>
                    <th>2月</th>
                    <th>3月</th>
                    <th>4月</th>
                    <th>5月</th>
                    <th>6月</th>
                    <th>7月</th>
                    <th>8月</th>
                    <th>9月</th>
                    <th>10月</th>
                    <th>11月</th>
                    <th>12月</th>
                </tr>
            </thead>
            <tbody>
                <!-- 各項目の行 -->
                <tr>
                    <td>旅費交通費</td>
                    <td><input type="number" id="travelExpenseRate" value="0.018" step="0.1"></td>
                    <td id="travelExpense37">0</td>
                    <td id="travelExpense38">0</td>
                    <td id="travelExpense39">0</td>
                    <td id="travelExpense40">0</td>
                    <td id="travelExpense41">0</td>
                    <td id="travelExpense42">0</td>
                    <td id="travelExpense43">0</td>
                    <td id="travelExpense44">0</td>
                    <td id="travelExpense45">0</td>
                    <td id="travelExpense46">0</td>
                    <td id="travelExpense47">0</td>
                    <td id="travelExpense48">0</td>
                </tr>
                <tr>
                    <td>接待交際費</td>
                    <td><input type="hidden" id="entertainmentExpenseRate"></td>
                    <td id="entertainmentExpense37">0</td>
                    <td id="entertainmentExpense38">0</td>
                    <td id="entertainmentExpense39">0</td>
                    <td id="entertainmentExpense40">0</td>
                    <td id="entertainmentExpense41">0</td>
                    <td id="entertainmentExpense42">0</td>
                    <td id="entertainmentExpense43">0</td>
                    <td id="entertainmentExpense44">0</td>
                    <td id="entertainmentExpense45">0</td>
                    <td id="entertainmentExpense46">0</td>
                    <td id="entertainmentExpense47">0</td>
                    <td id="entertainmentExpense48">0</td>
                </tr>
                <tr>
                    <td>通信費</td>
                    <td><input type="number" id="communicationCostRate" value="0.066" step="0.1"></td>
                    <td id="communicationCost37">0</td>
                    <td id="communicationCost38">0</td>
                    <td id="communicationCost39">0</td>
                    <td id="communicationCost40">0</td>
                    <td id="communicationCost41">0</td>
                    <td id="communicationCost42">0</td>
                    <td id="communicationCost43">0</td>
                    <td id="communicationCost44">0</td>
                    <td id="communicationCost45">0</td>
                    <td id="communicationCost46">0</td>
                    <td id="communicationCost47">0</td>
                    <td id="communicationCost48">0</td>
                </tr>
                <tr>
                    <td>公租公課</td>
                    <td><input type="number" id="publicTaxRate" value="0.055" step="0.1"></td>
                    <td id="publicTax37">0</td>
                    <td id="publicTax38">0</td>
                    <td id="publicTax39">0</td>
                    <td id="publicTax40">0</td>
                    <td id="publicTax41">0</td>
                    <td id="publicTax42">0</td>
                    <td id="publicTax43">0</td>
                    <td id="publicTax44">0</td>
                    <td id="publicTax45">0</td>
                    <td id="publicTax46">0</td>
                    <td id="publicTax47">0</td>
                    <td id="publicTax48">0</td>
                </tr>
                <tr>
                    <td>調査研究費</td>
                    <td><input type="hidden" id="researchCostRate"></td>
                    <td id="researchCost37">0</td>
                    <td id="researchCost38">0</td>
                    <td id="researchCost39">0</td>
                    <td id="researchCost40">0</td>
                    <td id="researchCost41">0</td>
                    <td id="researchCost42">0</td>
                    <td id="researchCost43">0</td>
                    <td id="researchCost44">0</td>
                    <td id="researchCost45">0</td>
                    <td id="researchCost46">0</td>
                    <td id="researchCost47">0</td>
                    <td id="researchCost48">0</td>
                </tr>
                <tr>
                    <td>事務用消耗品費</td>
                    <td><input type="number" id="officeSuppliesCostRate" value="0.311" step="0.1"></td>
                    <td id="officeSuppliesCost37">0</td>
                    <td id="officeSuppliesCost38">0</td>
                    <td id="officeSuppliesCost39">0</td>
                    <td id="officeSuppliesCost40">0</td>
                    <td id="officeSuppliesCost41">0</td>
                    <td id="officeSuppliesCost42">0</td>
                    <td id="officeSuppliesCost43">0</td>
                    <td id="officeSuppliesCost44">0</td>
                    <td id="officeSuppliesCost45">0</td>
                    <td id="officeSuppliesCost46">0</td>
                    <td id="officeSuppliesCost47">0</td>
                    <td id="officeSuppliesCost48">0</td>
                </tr>
                <tr>
                    <td>損害保険料</td>
                    <td><input type="number" id="insuranceFeeRate" value="0.030" step="0.1"></td>
                    <td id="insuranceFee37">0</td>
                    <td id="insuranceFee38">0</td>
                    <td id="insuranceFee39">0</td>
                    <td id="insuranceFee40">0</td>
                    <td id="insuranceFee41">0</td>
                    <td id="insuranceFee42">0</td>
                    <td id="insuranceFee43">0</td>
                    <td id="insuranceFee44">0</td>
                    <td id="insuranceFee45">0</td>
                    <td id="insuranceFee46">0</td>
                    <td id="insuranceFee47">0</td>
                    <td id="insuranceFee48">0</td>
                </tr>
                <tr>
                    <td>寄付金</td>
                    <td><input type="hidden" id="donationRate"></td>
                    <td id="donation37">0</td>
                    <td id="donation38">0</td>
                    <td id="donation39">0</td>
                    <td id="donation40">0</td>
                    <td id="donation41">0</td>
                    <td id="donation42">0</td>
                    <td id="donation43">0</td>
                    <td id="donation44">0</td>
                    <td id="donation45">0</td>
                    <td id="donation46">0</td>
                    <td id="donation47">0</td>
                    <td id="donation48">0</td>
                </tr>
                <tr>
                    <td>報酬及び料金</td>
                    <td><input type="hidden" id="rewardFeeRate"></td>
                    <td id="rewardFee37">0</td>
                    <td id="rewardFee38">0</td>
                    <td id="rewardFee39">0</td>
                    <td id="rewardFee40">0</td>
                    <td id="rewardFee41">0</td>
                    <td id="rewardFee42">0</td>
                    <td id="rewardFee43">0</td>
                    <td id="rewardFee44">0</td>
                    <td id="rewardFee45">0</td>
                    <td id="rewardFee46">0</td>
                    <td id="rewardFee47">0</td>
                    <td id="rewardFee48">0</td>
                </tr>
                <tr>
                    <td>本社経費負担金</td>
                    <td><input type="number" id="hqExpenseBurdenRate" value="0.043" step="0.1"></td>
                    <td id="hqExpenseBurden37">0</td>
                    <td id="hqExpenseBurden38">0</td>
                    <td id="hqExpenseBurden39">0</td>
                    <td id="hqExpenseBurden40">0</td>
                    <td id="hqExpenseBurden41">0</td>
                    <td id="hqExpenseBurden42">0</td>
                    <td id="hqExpenseBurden43">0</td>
                    <td id="hqExpenseBurden44">0</td>
                    <td id="hqExpenseBurden45">0</td>
                    <td id="hqExpenseBurden46">0</td>
                    <td id="hqExpenseBurden47">0</td>
                    <td id="hqExpenseBurden48">0</td>
                </tr>
                <tr>
                    <td>本社経費負担金受入</td>
                    <td><input type="hidden" id="hqExpenseAcceptanceRate"></td>
                    <td id="hqExpenseAcceptance37">0</td>
                    <td id="hqExpenseAcceptance38">0</td>
                    <td id="hqExpenseAcceptance39">0</td>
                    <td id="hqExpenseAcceptance40">0</td>
                    <td id="hqExpenseAcceptance41">0</td>
                    <td id="hqExpenseAcceptance42">0</td>
                    <td id="hqExpenseAcceptance43">0</td>
                    <td id="hqExpenseAcceptance44">0</td>
                    <td id="hqExpenseAcceptance45">0</td>
                    <td id="hqExpenseAcceptance46">0</td>
                    <td id="hqExpenseAcceptance47">0</td>
                    <td id="hqExpenseAcceptance48">0</td>
                </tr>
                <tr>
                    <td>関係会社経費負担金</td>
                    <td><input type="hidden" id="relatedCompanyExpenseBurdenRate"></td>
                    <td id="relatedCompanyExpenseBurden37">0</td>
                    <td id="relatedCompanyExpenseBurden38">0</td>
                    <td id="relatedCompanyExpenseBurden39">0</td>
                    <td id="relatedCompanyExpenseBurden40">0</td>
                    <td id="relatedCompanyExpenseBurden41">0</td>
                    <td id="relatedCompanyExpenseBurden42">0</td>
                    <td id="relatedCompanyExpenseBurden43">0</td>
                    <td id="relatedCompanyExpenseBurden44">0</td>
                    <td id="relatedCompanyExpenseBurden45">0</td>
                    <td id="relatedCompanyExpenseBurden46">0</td>
                    <td id="relatedCompanyExpenseBurden47">0</td>
                    <td id="relatedCompanyExpenseBurden48">0</td>
                </tr>
                <tr>
                    <td>販売支払手数料</td>
                    <td><input type="hidden" id="salesCommissionRate"></td>
                    <td id="salesCommission37">0</td>
                    <td id="salesCommission38">0</td>
                    <td id="salesCommission39">0</td>
                    <td id="salesCommission40">0</td>
                    <td id="salesCommission41">0</td>
                    <td id="salesCommission42">0</td>
                    <td id="salesCommission43">0</td>
                    <td id="salesCommission44">0</td>
                    <td id="salesCommission45">0</td>
                    <td id="salesCommission46">0</td>
                    <td id="salesCommission47">0</td>
                    <td id="salesCommission48">0</td>
                </tr>
                <tr>
                    <td>関係販売支払手数料</td>
                    <td><input type="number" id="relatedSalesCommissionRate" value="0" step="0.1"></td>
                    <td id="relatedSalesCommission37">0</td>
                    <td id="relatedSalesCommission38">0</td>
                    <td id="relatedSalesCommission39">0</td>
                    <td id="relatedSalesCommission40">0</td>
                    <td id="relatedSalesCommission41">0</td>
                    <td id="relatedSalesCommission42">0</td>
                    <td id="relatedSalesCommission43">0</td>
                    <td id="relatedSalesCommission44">0</td>
                    <td id="relatedSalesCommission45">0</td>
                    <td id="relatedSalesCommission46">0</td>
                    <td id="relatedSalesCommission47">0</td>
                    <td id="relatedSalesCommission48">0</td>
                </tr>
                <tr>
                    <td>貸倒損失</td>
                    <td><input type="hidden" id="badDebtLossRate"></td>
                    <td id="badDebtLoss37">0</td>
                    <td id="badDebtLoss38">0</td>
                    <td id="badDebtLoss39">0</td>
                    <td id="badDebtLoss40">0</td>
                    <td id="badDebtLoss41">0</td>
                    <td id="badDebtLoss42">0</td>
                    <td id="badDebtLoss43">0</td>
                    <td id="badDebtLoss44">0</td>
                    <td id="badDebtLoss45">0</td>
                    <td id="badDebtLoss46">0</td>
                    <td id="badDebtLoss47">0</td>
                    <td id="badDebtLoss48">0</td>
                </tr>
                <tr>
                    <td>貸倒引当金繰入</td>
                    <td><input type="hidden" id="badDebtProvisionRate"></td>
                    <td id="badDebtProvision37">0</td>
                    <td id="badDebtProvision38">0</td>
                    <td id="badDebtProvision39">0</td>
                    <td id="badDebtProvision40">0</td>
                    <td id="badDebtProvision41">0</td>
                    <td id="badDebtProvision42">0</td>
                    <td id="badDebtProvision43">0</td>
                    <td id="badDebtProvision44">0</td>
                    <td id="badDebtProvision45">0</td>
                    <td id="badDebtProvision46">0</td>
                    <td id="badDebtProvision47">0</td>
                    <td id="badDebtProvision48">0</td>
                </tr>
                <tr>
                    <td>雑費</td>
                    <td><input type="number" id="miscellaneousExpenseRate" value="0.053" step="0.1"></td>
                    <td id="miscellaneousExpense37">0</td>
                    <td id="miscellaneousExpense38">0</td>
                    <td id="miscellaneousExpense39">0</td>
                    <td id="miscellaneousExpense40">0</td>
                    <td id="miscellaneousExpense41">0</td>
                    <td id="miscellaneousExpense42">0</td>
                    <td id="miscellaneousExpense43">0</td>
                    <td id="miscellaneousExpense44">0</td>
                    <td id="miscellaneousExpense45">0</td>
                    <td id="miscellaneousExpense46">0</td>
                    <td id="miscellaneousExpense47">0</td>
                    <td id="miscellaneousExpense48">0</td>
                </tr>
                <tr>
                    <td>事業部経費負担金</td>
                    <td><input type="number" id="businessUnitExpenseBurdenRate" value="0.012" step="0.1"></td>
                    <td id="businessUnitExpenseBurden37">0</td>
                    <td id="businessUnitExpenseBurden38">0</td>
                    <td id="businessUnitExpenseBurden39">0</td>
                    <td id="businessUnitExpenseBurden40">0</td>
                    <td id="businessUnitExpenseBurden41">0</td>
                    <td id="businessUnitExpenseBurden42">0</td>
                    <td id="businessUnitExpenseBurden43">0</td>
                    <td id="businessUnitExpenseBurden44">0</td>
                    <td id="businessUnitExpenseBurden45">0</td>
                    <td id="businessUnitExpenseBurden46">0</td>
                    <td id="businessUnitExpenseBurden47">0</td>
                    <td id="businessUnitExpenseBurden48">0</td>
                </tr>
                <tr>
                    <td>商品部経費負担金</td>
                    <td><input type="number" id="productDeptExpenseBurdenRate" value="0.008" step="0.1"></td>
                    <td id="productDeptExpenseBurden37">0</td>
                    <td id="productDeptExpenseBurden38">0</td>
                    <td id="productDeptExpenseBurden39">0</td>
                    <td id="productDeptExpenseBurden40">0</td>
                    <td id="productDeptExpenseBurden41">0</td>
                    <td id="productDeptExpenseBurden42">0</td>
                    <td id="productDeptExpenseBurden43">0</td>
                    <td id="productDeptExpenseBurden44">0</td>
                    <td id="productDeptExpenseBurden45">0</td>
                    <td id="productDeptExpenseBurden46">0</td>
                    <td id="productDeptExpenseBurden47">0</td>
                    <td id="productDeptExpenseBurden48">0</td>
                </tr>
                <tr>
                    <td>一般費計</td>
                    <td><input type="hidden"></td>
                    <td id="total-generalMonthly37" value="0"></td>
                    <td id="total-generalMonthly38" value="0"></td>
                    <td id="total-generalMonthly39" value="0"></td>
                    <td id="total-generalMonthly40" value="0"></td>
                    <td id="total-generalMonthly41" value="0"></td>
                    <td id="total-generalMonthly42" value="0"></td>
                    <td id="total-generalMonthly43" value="0"></td>
                    <td id="total-generalMonthly44" value="0"></td>
                    <td id="total-generalMonthly45" value="0"></td>
                    <td id="total-generalMonthly46" value="0"></td>
                    <td id="total-generalMonthly47" value="0"></td>
                    <td id="total-generalMonthly48" value="0"></td>
                </tr>
            </tbody>
        </table>
        <div id="total-container">
            <span>年間計:</span>
            <span id="total-value">0</span>
        </div>
        <br>
        <div class="div-flex">
        <button class="btn-save" type="button" id="save-button">更新</button>
        <button class="btn-close" type="button" onclick="window.close()">タブを閉じる</button>
        </div>
    </form>

    <script type="module">
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5Q-33mnR0OHCIgRfsZQqhp3DtJl_HqSo",
            authDomain: "localstorage-350f8.firebaseapp.com",
            projectId: "localstorage-350f8",
            storageBucket: "localstorage-350f8.appspot.com",
            messagingSenderId: "813792564394",
            appId: "1:813792564394:web:f0647834bbfc23e6c36cd3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const propertyId = new URLSearchParams(window.location.search).get('id');
        // 初期費用のデータ取得
        let depreciation = 0; // 償却月数
        // 旅費交通費
        let displaySupport = 0; // 陳列応援経費
        let preOpeningPersonnel = 0; // 開店前人件費

        // 雑費
        let depositInterest = 0; // 保証金金利額
        let recruitmentCost = 0; // 採用費（会場・媒体）
        let applicationFee = 0; // 各種申請料
        let designFee = 0; // 設計料

        async function loadSalesData() {
            if (!propertyId) return;
            const docRef = doc(db, "properties", propertyId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                const salesData = [
                    data.salesMonthly37, data.salesMonthly38, data.salesMonthly39,
                    data.salesMonthly40, data.salesMonthly41, data.salesMonthly42,
                    data.salesMonthly43, data.salesMonthly44, data.salesMonthly45,
                    data.salesMonthly46, data.salesMonthly47, data.salesMonthly48
                ];
                // Firebaseから取得した値を変数に設定
                if (data.depreciation) {
                    depreciation = data.depreciation;
                }

                if (data.displaySupport) {
                    displaySupport = data.displaySupport;
                }
                if (data.preOpeningPersonnel) {
                    preOpeningPersonnel = data.preOpeningPersonnel;
                }
                if (data.depositInterest) {
                    depositInterest = data.depositInterest;
                }
                if (data.recruitmentCost) {
                    recruitmentCost = data.recruitmentCost;
                }
                
                if (data.applicationFee) {
                    applicationFee = data.applicationFee;
                }
                if (data.designFee) {
                    designFee = data.designFee;
                }
                updateAllExpenses(salesData);
            } else {
                console.log("No such document!");
            }
        }

        function calculateAndDisplayExpenses(expenseType, salesData) {
            const rateInput = document.getElementById(`${expenseType}Rate`);
            if (!rateInput) {
                console.error(`Element with ID ${expenseType}Rate not found`);
            }
            const rate = rateInput ? Number(rateInput.value) / 100 : 0;

            // 旅費交通費の計算
            const travelExpense = displaySupport + preOpeningPersonnel;

            // 雑費の計算
            const miscellaneousExpense = depositInterest + recruitmentCost + applicationFee + designFee;

            salesData.forEach((sales, index) => {
                const month = index + 37;
                let calculatedValue = sales * rate;

                // その他
                document.getElementById(`${expenseType}${month}`).innerText = calculatedValue.toFixed(0);
            });

            calculateTotal();
        }


        function setupExpenseCalculation() {
            const expenseTypes = ["travelExpense", "miscellaneousExpense"];
    
            expenseTypes.forEach(expenseType => {
                const element = document.getElementById(`${expenseType}Rate`);
                if (element) { // nullチェックを追加
                    element.addEventListener("change", () => updateExpenses(expenseType));
                } else {
                    console.error(`Element with ID ${expenseType}Rate not found`);
                }
            });
        }

        function updateAllExpenses(salesData) {
            const expenseTypes = ["travelExpense", "entertainmentExpense", "communicationCost", "publicTax", "researchCost", "officeSuppliesCost", "insuranceFee", "donation", "rewardFee", "hqExpenseBurden", "hqExpenseAcceptance", "relatedCompanyExpenseBurden", "salesCommission", "relatedSalesCommission", "badDebtLoss", "badDebtProvision", "miscellaneousExpense", "businessUnitExpenseBurden", "productDeptExpenseBurden"];
            expenseTypes.forEach(expenseType => {
                setupExpenseCalculation(expenseType, salesData);
                calculateAndDisplayExpenses(expenseType, salesData); // 初期計算
            });
        }

        function calculateTotal() {
            let total = 0;
            const expenseTypes = ["travelExpense", "entertainmentExpense", "communicationCost", "publicTax", "researchCost", "officeSuppliesCost", "insuranceFee", "donation", "rewardFee", "hqExpenseBurden", "hqExpenseAcceptance", "relatedCompanyExpenseBurden", "salesCommission", "relatedSalesCommission", "badDebtLoss", "badDebtProvision", "miscellaneousExpense", "businessUnitExpenseBurden", "productDeptExpenseBurden"];

            // 各月の合計を保存するためのオブジェクト
            const monthlyTotals = {};

            // 1月から12月までの合計を計算
            for (let i = 37; i <= 48; i++) {
                let monthlyTotal = 0;
                expenseTypes.forEach(expenseType => {
                    const value = Number(document.getElementById(`${expenseType}${i}`).innerText) || 0;
                    monthlyTotal += value;
                });

                // 各月の合計を保存
                monthlyTotals[`total-generalMonthly${i}`] = monthlyTotal;

                // 各月の合計を表示
                document.getElementById(`total-generalMonthly${i}`).textContent = Math.trunc(monthlyTotal).toLocaleString();

                // 総合計に各月の合計を加算
                total += monthlyTotal;
            }

            // 総合計を表示
            document.getElementById("total-value").textContent = Math.trunc(total).toLocaleString();

            return monthlyTotals; // 月ごとの合計を返す
        }

        document.getElementById("save-button").addEventListener("click", async () => {
            const updatedExpenses = {};
            const expenseTypes = ["travelExpense", "entertainmentExpense", "communicationCost", "publicTax", "researchCost", "officeSuppliesCost", "insuranceFee", "donation", "rewardFee", "hqExpenseBurden", "hqExpenseAcceptance", "relatedCompanyExpenseBurden", "salesCommission", "relatedSalesCommission", "badDebtLoss", "badDebtProvision", "miscellaneousExpense", "businessUnitExpenseBurden", "productDeptExpenseBurden"];

            // 月ごとの合計値を保存するオブジェクト
            const monthlyTotals = calculateTotal(); // calculateTotal関数を呼び出し、月ごとの合計を取得

            for (let i = 37; i <= 48; i++) {
                let monthlyTotal = 0;
                expenseTypes.forEach(expenseType => {
                    const value = Number(document.getElementById(`${expenseType}${i}`).innerText) || 0;
                    updatedExpenses[`${expenseType}${i}`] = value;
                    monthlyTotal += value;
                });
                // 月ごとの合計を表示（既に calculateTotal 関数で行っているため、ここで再計算しなくてもOK）
                monthlyTotals[`total-generalMonthly${i}`] = monthlyTotal; // 合計値をオブジェクトに保存
            }

            if (propertyId) {
                const docRef = doc(db, "properties", propertyId);
                const updateData = {
                    general4: Number(document.getElementById("total-value").textContent.replace(/,/g, '')),
                    ...monthlyTotals // 月ごとの合計値を一緒に保存
                };

                await updateDoc(docRef, updatedExpenses);
                await updateDoc(docRef, updateData);
                alert("データが保存されました。");
            } else {
                alert("プロパティIDが指定されていません。");
            }
        });


        // エンターキーを無効化するイベントリスナー
        document.getElementById("general-edit-form").addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
            }
        });

        loadSalesData();
    </script>
</body>
</html>
